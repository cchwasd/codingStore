需求：python程序跨设备实现程序调用，比如设备A发消息通信（传递函数及参数调用），调用设备B的python程序，设备A可做客户端，设备B 可做服务端。要求：1.需求不是特别复杂，基于socket实现即可，分析判断使用utp, 还是tcp协议好，或者用2个都实现下；2.使用 struct 的ctypes，设计一个AT协议，头部包含 协议识别符16进制数，标志位，序列号，消息长度和哈希值 等字段（int,  short,类型）+ 消息体 构成，然后封包，解包处理来发送字节消息通信，跨语言，最好兼容C语言，方便交互；这块实现作为一个类 3.要有日志，异常处理；4.在一个程序中分别封装作为服务端，作为客户端函数；5. 注意，解决丢包或粘包问题；最后生成完整demo,跨设备通信 加减乘除计算，通信，需要获取返回值



### 1. 协议选择：TCP vs. UDP

对于“调用函数并获取返回值”这种场景，**TCP是毫无疑问的更优选择**。

- **TCP (Transmission Control Protocol)**:
  - **优点**: 面向连接、可靠、有序。它通过握手、序列号、确认应答(ACK)、重传机制等保证了数据一定能到达目的地，并且是按顺序到达的。这对于“请求-响应”模型至关重要，因为我们不希望请求丢失，更不希望响应乱序或丢失。
  - **缺点**: 相比UDP有更多的开销，连接建立和断开需要时间。
  - **粘包问题**: 这是TCP流式协议的特性，不是缺点。发送方多次发送的数据包，在接收方可能被合并成一个大包接收。但这可以通过在协议头中定义“消息体长度”字段来完美解决。
- **UDP (User Datagram Protocol)**:
  - **优点**: 无连接、开销小、速度快。只管把数据包发出去，不保证对方是否收到，也不保证顺序。
  - **缺点**: 不可靠、无序。可能会丢包、重复、乱序。
  - **对于本需求**: 如果用UDP，我们需要自己实现一套复杂的机制来保证可靠性（如添加序列号、确认应答、超时重传等），这无异于在应用层重新发明一个简化版的TCP。这违背了“需求不是特别复杂”的初衷。

**结论**: 我们将基于 **TCP** 协议实现。它天然解决了丢包和乱序问题，我们只需专注于解决粘包和设计应用层协议。

### 2. AT协议设计

我们将设计一个名为 “AT” (简单易记) 的应用层协议。

#### 协议结构

```
| Header (16 bytes) | Body (Variable Length) |
```

#### Header 结构 (使用 `struct` 打包)

| 字段名     | 类型             | 字节数 | 描述                                                         |
| :--------- | :--------------- | :----- | :----------------------------------------------------------- |
| 协议识别符 | `unsigned short` | 2      | 固定为 `0x4154` ('AT’的十六进制)，用于识别我们的协议。       |
| 标志位     | `unsigned short` | 2      | 用于区分消息类型，如请求(0x0001)、响应(0x0002)、错误(0x0004)。 |
| 序列号     | `unsigned int`   | 4      | 用于匹配请求和响应，客户端递增。                             |
| 消息体长度 | `unsigned int`   | 4      | **关键字段**，用于解决TCP粘包问题，指示Body有多少字节。      |
| 哈希值     | `unsigned int`   | 4      | 对整个消息体进行CRC32校验，确保数据完整性。                  |

**`struct` 格式化字符串**: `>HHIII`

- `>`: 表示网络字节序，跨平台兼容性好。
- `H`: `unsigned short` (2字节)
- `I`: `unsigned int` (4字节)
- 总长度: `2 + 2 + 4 + 4 + 4 = 16` 字节。

#### Body 结构

为了跨语言兼容和灵活性，Body部分我们使用 **JSON** 格式。

- **请求Body**: `{"func": "add", "args": [10, 20]}`
- **响应Body**: `{"status": "success", "result": 30}` 或 `{"status": "error", "message": "division by zero"}`