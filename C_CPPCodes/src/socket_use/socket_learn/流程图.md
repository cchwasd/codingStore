# 多线程Socket通讯流程图

## 整体架构图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   客户端1        │    │   客户端2        │    │   客户端N        │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │  主线程     │ │    │ │  主线程     │ │    │ │  主线程     │ │
│ │ (发送消息)  │ │    │ │ (发送消息)  │ │    │ │ (发送消息)  │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │ 接收线程    │ │    │ │ 接收线程    │ │    │ │ 接收线程    │ │
│ │ (接收消息)  │ │    │ │ (接收消息)  │ │    │ │ (接收消息)  │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │    服务器        │
                    │                 │
                    │ ┌─────────────┐ │
                    │ │  主线程     │ │
                    │ │(接受连接)   │ │
                    │ └─────────────┘ │
                    │ ┌─────────────┐ │
                    │ │ 工作线程1   │ │
                    │ │(处理客户端1)│ │
                    │ └─────────────┘ │
                    │ ┌─────────────┐ │
                    │ │ 工作线程2   │ │
                    │ │(处理客户端2)│ │
                    │ └─────────────┘ │
                    │ ┌─────────────┐ │
                    │ │ 工作线程N   │ │
                    │ │(处理客户端N)│ │
                    │ └─────────────┘ │
                    └─────────────────┘
```

## 服务器端详细流程图

```mermaid
flowchart TD
    A[服务器启动] --> B[初始化WSA]
    B --> C[创建Socket]
    C --> D[绑定地址和端口]
    D --> E[开始监听]
    E --> F[主线程循环]
    F --> G[等待客户端连接]
    G --> H{有新连接?}
    H -->|是| I[接受客户端连接]
    H -->|否| F
    I --> J[创建客户端线程结构]
    J --> K[分配线程ID]
    K --> L[创建新线程]
    L --> M[线程分离运行]
    M --> N[添加到线程向量]
    N --> F
    
    subgraph "工作线程处理"
        O[工作线程启动] --> P[设置运行标志]
        P --> Q[循环接收数据]
        Q --> R{接收到数据?}
        R -->|是| S[处理消息]
        R -->|否| T[检查连接状态]
        S --> U[发送响应]
        U --> Q
        T --> V{连接正常?}
        V -->|是| Q
        V -->|否| W[设置停止标志]
        W --> X[线程结束]
    end
```

## 客户端详细流程图

```mermaid
flowchart TD
    A[客户端启动] --> B[初始化WSA]
    B --> C[创建Socket]
    C --> D[连接服务器]
    D --> E{连接成功?}
    E -->|否| F[连接失败]
    E -->|是| G[初始化接收线程]
    G --> H[启动接收线程]
    H --> I[主线程发送消息]
    
    subgraph "主线程"
        I --> J[用户输入消息]
        J --> K[发送到服务器]
        K --> L{继续发送?}
        L -->|是| J
        L -->|否| M[程序结束]
    end
    
    subgraph "接收线程"
        N[接收线程启动] --> O[设置运行标志]
        O --> P[循环接收数据]
        P --> Q{接收到数据?}
        Q -->|是| R[显示消息]
        Q -->|否| S[检查连接状态]
        R --> P
        S --> T{连接正常?}
        T -->|是| P
        T -->|否| U[设置停止标志]
        U --> V[线程结束]
    end
```

## 多线程交互时序图

```mermaid
sequenceDiagram
    participant Server as 服务器主线程
    participant Worker1 as 工作线程1
    participant Worker2 as 工作线程2
    participant Client1 as 客户端1
    participant Client2 as 客户端2
    
    Note over Server: 服务器启动并监听
    
    Client1->>Server: 连接请求
    Server->>Worker1: 创建线程处理客户端1
    Server->>Client1: 连接确认
    
    Client2->>Server: 连接请求
    Server->>Worker2: 创建线程处理客户端2
    Server->>Client2: 连接确认
    
    Client1->>Worker1: 发送消息1
    Worker1->>Client1: 响应消息1
    
    Client2->>Worker2: 发送消息2
    Worker2->>Client2: 响应消息2
    
    Client1->>Worker1: 发送消息3
    Worker1->>Client1: 响应消息3
    
    Note over Client1: 客户端1断开连接
    Worker1->>Server: 线程结束通知
    
    Note over Client2: 客户端2断开连接
    Worker2->>Server: 线程结束通知
```

## 线程生命周期管理

### 服务器线程生命周期

```
线程创建 → 线程运行 → 线程结束
    ↓           ↓         ↓
分配资源    处理消息    释放资源
    ↓           ↓         ↓
添加到向量   循环接收    从向量移除
```

### 客户端线程生命周期

```
主线程启动 → 创建接收线程 → 主线程发送消息
    ↓              ↓              ↓
初始化Socket   接收线程运行    用户输入处理
    ↓              ↓              ↓
连接服务器    循环接收数据    发送到服务器
    ↓              ↓              ↓
连接成功      显示接收消息    程序结束
```

## 关键数据结构关系

```
SocketServerTest
├── m_nServerSocket (服务器Socket)
├── m_Vecthread (线程向量)
│   ├── Sthread[0]
│   │   ├── t1 (线程指针)
│   │   ├── isRuning (运行标志)
│   │   ├── threadID (线程ID)
│   │   └── csocket (客户端Socket)
│   ├── Sthread[1]
│   └── ...
└── m_CsocketCount (线程计数器)

MultipartiteClientSocketTest
├── m_nLocalSocket (客户端Socket)
├── m_message (消息缓冲区)
└── recvThread (接收线程)
    ├── t1 (线程指针)
    └── isRuning (运行标志)
```

## 错误处理流程

```mermaid
flowchart TD
    A[操作开始] --> B{操作成功?}
    B -->|是| C[继续执行]
    B -->|否| D[错误处理]
    D --> E[记录错误信息]
    E --> F{可恢复错误?}
    F -->|是| G[重试操作]
    F -->|否| H[关闭连接]
    G --> B
    H --> I[清理资源]
    I --> J[线程结束]
```

## 性能优化建议

1. **线程池管理**：避免频繁创建销毁线程
2. **缓冲区优化**：使用适当大小的接收缓冲区
3. **连接复用**：实现连接池机制
4. **异步I/O**：使用IOCP或epoll提高性能
5. **消息队列**：使用队列缓冲消息处理 