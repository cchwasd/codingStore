# Socketé€šè®¯ä»£ç ä¼˜åŒ–è¯´æ˜

## 1. ä¼˜åŒ–æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–å°†åŸæœ‰çš„è¿‡ç¨‹å¼ä»£ç é‡æ„ä¸ºé¢å‘å¯¹è±¡çš„è®¾è®¡ï¼Œä¸»è¦æ”¹è¿›åŒ…æ‹¬ï¼š

- **ç±»å°è£…**ï¼šå°†SocketåŠŸèƒ½å°è£…åˆ°ç±»ä¸­ï¼Œæé«˜ä»£ç å¤ç”¨æ€§å’Œå¯ç»´æŠ¤æ€§
- **çº¿ç¨‹å®‰å…¨**ï¼šä½¿ç”¨äº’æ–¥é”å’ŒåŸå­å˜é‡ç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å®‰å…¨æ€§
- **é”™è¯¯å¤„ç†**ï¼šå®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œèµ„æºç®¡ç†
- **æ‰©å±•æ€§**ï¼šæ”¯æŒåŠ¨æ€æ³¨å†Œå‡½æ•°å’Œå›è°ƒæœºåˆ¶
- **å¯é…ç½®æ€§**ï¼šæ”¯æŒå¤šç§é…ç½®é€‰é¡¹å’Œå‚æ•°è°ƒæ•´

## 2. åŸç‰ˆæœ¬é—®é¢˜åˆ†æ

### 2.1 ä»£ç ç»“æ„é—®é¢˜

**åŸç‰ˆæœ¬é—®é¢˜ï¼š**
```cpp
// å…¨å±€å˜é‡å’Œå‡½æ•°æ··åˆ
int add_func(int num1, int num2) { return num1 + num2; }
std::map<std::string, std::function<int(int, int)>> function_map;

// å‡½æ•°å¼ç¼–ç¨‹é£æ ¼ï¼Œç¼ºä¹å°è£…
int server_tcp_link(int cfd, sockaddr_in cddr) {
    // å¤§é‡é‡å¤ä»£ç 
    // ç¼ºä¹é”™è¯¯å¤„ç†
    // èµ„æºç®¡ç†ä¸å½“
}
```

**ä¼˜åŒ–åï¼š**
```cpp
class OptimizedServer {
private:
    std::map<std::string, std::function<int(int, int)>> functionMap;
    std::mutex functionMutex;
    
public:
    template<typename Func>
    void registerFunction(const std::string& name, Func func) {
        std::lock_guard<std::mutex> lock(functionMutex);
        functionMap[name] = func;
    }
};
```

### 2.2 çº¿ç¨‹å®‰å…¨é—®é¢˜

**åŸç‰ˆæœ¬é—®é¢˜ï¼š**
- æ²¡æœ‰ä½¿ç”¨äº’æ–¥é”ä¿æŠ¤å…±äº«èµ„æº
- å®¢æˆ·ç«¯åˆ—è¡¨å¯èƒ½å­˜åœ¨ç«æ€æ¡ä»¶
- çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯ç¼ºä¹åŒæ­¥æœºåˆ¶

**ä¼˜åŒ–åï¼š**
```cpp
class OptimizedServer {
private:
    std::vector<std::unique_ptr<ClientInfo>> clients;
    mutable std::mutex clientsMutex;
    std::atomic<bool> running{false};
    std::atomic<int> clientCounter{0};
};
```

### 2.3 èµ„æºç®¡ç†é—®é¢˜

**åŸç‰ˆæœ¬é—®é¢˜ï¼š**
- Socketèµ„æºå¯èƒ½æ³„æ¼
- çº¿ç¨‹èµ„æºç®¡ç†ä¸å½“
- ç¼ºä¹RAIIåŸåˆ™

**ä¼˜åŒ–åï¼š**
```cpp
class OptimizedServer {
public:
    ~OptimizedServer() {
        stop();
        cleanup();
    }
    
private:
    void cleanup() {
        #ifdef _WIN32
        WSACleanup();
        #endif
    }
};
```

## 3. ä¼˜åŒ–è¯¦ç»†å¯¹æ¯”

### 3.1 æœåŠ¡å™¨ç«¯å¯¹æ¯”

| ç‰¹æ€§ | åŸç‰ˆæœ¬ | ä¼˜åŒ–ç‰ˆæœ¬ |
|------|--------|----------|
| ä»£ç ç»„ç»‡ | è¿‡ç¨‹å¼å‡½æ•° | é¢å‘å¯¹è±¡ç±» |
| çº¿ç¨‹å®‰å…¨ | æ— ä¿æŠ¤ | äº’æ–¥é”+åŸå­å˜é‡ |
| é”™è¯¯å¤„ç† | åŸºæœ¬é”™è¯¯æ£€æŸ¥ | å¼‚å¸¸å¤„ç†+æ—¥å¿— |
| èµ„æºç®¡ç† | æ‰‹åŠ¨ç®¡ç† | RAIIè‡ªåŠ¨ç®¡ç† |
| æ‰©å±•æ€§ | ç¡¬ç¼–ç å‡½æ•° | åŠ¨æ€æ³¨å†Œå‡½æ•° |
| é…ç½®æ€§ | ç¡¬ç¼–ç å‚æ•° | å¯é…ç½®å‚æ•° |

### 3.2 å®¢æˆ·ç«¯å¯¹æ¯”

| ç‰¹æ€§ | åŸç‰ˆæœ¬ | ä¼˜åŒ–ç‰ˆæœ¬ |
|------|--------|----------|
| è¿æ¥ç®¡ç† | ç®€å•è¿æ¥ | çŠ¶æ€æœº+é‡è¿æœºåˆ¶ |
| æ¶ˆæ¯å¤„ç† | åŒæ­¥å¤„ç† | å¼‚æ­¥+å›è°ƒæœºåˆ¶ |
| é”™è¯¯æ¢å¤ | æ—  | è‡ªåŠ¨é‡è¿ |
| ç»Ÿè®¡ä¿¡æ¯ | æ—  | è¯¦ç»†ç»Ÿè®¡ |
| é…ç½®é€‰é¡¹ | æ—  | å¤šç§é…ç½® |

## 4. æ ¸å¿ƒä¼˜åŒ–ç‚¹

### 4.1 ç±»è®¾è®¡ä¼˜åŒ–

**æœåŠ¡å™¨ç±»è®¾è®¡ï¼š**
```cpp
class OptimizedServer {
public:
    // å…¬å…±æ¥å£
    bool start();
    void stop();
    bool isRunning() const;
    
    // æ‰©å±•æ¥å£
    template<typename Func>
    void registerFunction(const std::string& name, Func func);
    
    // ç»Ÿè®¡æ¥å£
    int getConnectedClients() const;
    std::vector<std::string> getClientList() const;

private:
    // å†…éƒ¨å®ç°
    void acceptLoop();
    void handleClient(std::unique_ptr<ClientInfo> client);
    std::string processJsonRequest(const std::string& jsonStr);
};
```

**å®¢æˆ·ç«¯ç±»è®¾è®¡ï¼š**
```cpp
class OptimizedClient {
public:
    // è¿æ¥ç®¡ç†
    bool connect();
    void disconnect();
    bool isConnected() const;
    
    // æ¶ˆæ¯å‘é€
    bool sendMessage(const std::string& message);
    bool sendJsonRequest(const std::string& function, int num1, int num2);
    
    // å›è°ƒè®¾ç½®
    void setMessageCallback(std::function<void(const std::string&)> callback);
    void setStatusCallback(std::function<void(ConnectionStatus)> callback);
    
    // é…ç½®é€‰é¡¹
    void setReconnectEnabled(bool enabled);
    void setReconnectInterval(int seconds);
};
```

### 4.2 çº¿ç¨‹å®‰å…¨ä¼˜åŒ–

**äº’æ–¥é”ä¿æŠ¤ï¼š**
```cpp
class OptimizedServer {
private:
    mutable std::mutex clientsMutex;
    mutable std::mutex functionMutex;
    
public:
    void addClient(std::unique_ptr<ClientInfo> client) {
        std::lock_guard<std::mutex> lock(clientsMutex);
        clients.push_back(std::move(client));
    }
};
```

**åŸå­å˜é‡ï¼š**
```cpp
class OptimizedServer {
private:
    std::atomic<bool> running{false};
    std::atomic<int> clientCounter{0};
};
```

### 4.3 é”™è¯¯å¤„ç†ä¼˜åŒ–

**å¼‚å¸¸å¤„ç†ï¼š**
```cpp
bool OptimizedServer::start() {
    try {
        if (!initialize()) {
            logError("Failed to initialize server");
            return false;
        }
        // ...
    } catch (const std::exception& e) {
        logError("Server start failed: " + std::string(e.what()));
        return false;
    }
}
```

**æ—¥å¿—ç³»ç»Ÿï¼š**
```cpp
void OptimizedServer::logMessage(const std::string& message) const {
    std::cout << "[" << getCurrentTime() << "] [INFO] " << message << std::endl;
}

void OptimizedServer::logError(const std::string& error) const {
    std::cerr << "[" << getCurrentTime() << "] [ERROR] " << error << std::endl;
}
```

### 4.4 èµ„æºç®¡ç†ä¼˜åŒ–

**RAIIåŸåˆ™ï¼š**
```cpp
class OptimizedServer {
public:
    OptimizedServer(const std::string& ip, int port) {
        // æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–èµ„æº
    }
    
    ~OptimizedServer() {
        // ææ„å‡½æ•°ä¸­è‡ªåŠ¨æ¸…ç†èµ„æº
        stop();
        cleanup();
    }
};
```

**æ™ºèƒ½æŒ‡é’ˆï¼š**
```cpp
std::vector<std::unique_ptr<ClientInfo>> clients;
```

## 5. æ€§èƒ½ä¼˜åŒ–

### 5.1 å†…å­˜ç®¡ç†

**åŸç‰ˆæœ¬ï¼š**
```cpp
Sthread *it = new Sthread();  // æ‰‹åŠ¨å†…å­˜ç®¡ç†
```

**ä¼˜åŒ–ç‰ˆæœ¬ï¼š**
```cpp
auto clientInfo = std::make_unique<ClientInfo>(clientSocket, clientIP, clientPort, clientId);
```

### 5.2 ç¼“å†²åŒºä¼˜åŒ–

**åŸç‰ˆæœ¬ï¼š**
```cpp
char buff[65535];  // å›ºå®šå¤§ç¼“å†²åŒº
```

**ä¼˜åŒ–ç‰ˆæœ¬ï¼š**
```cpp
const int bufferSize = 1024;  // åˆç†å¤§å°
char buffer[bufferSize];
```

### 5.3 çº¿ç¨‹æ± è€ƒè™‘

è™½ç„¶å½“å‰ç‰ˆæœ¬ä¸ºæ¯ä¸ªå®¢æˆ·ç«¯åˆ›å»ºç‹¬ç«‹çº¿ç¨‹ï¼Œä½†ä¸ºæœªæ¥æ‰©å±•é¢„ç•™äº†æ¥å£ï¼š

```cpp
// æœªæ¥å¯ä»¥æ‰©å±•ä¸ºçº¿ç¨‹æ± æ¨¡å¼
class ThreadPool {
    // çº¿ç¨‹æ± å®ç°
};
```

## 6. æ‰©å±•æ€§è®¾è®¡

### 6.1 å‡½æ•°æ³¨å†Œæœºåˆ¶

```cpp
// æ”¯æŒåŠ¨æ€æ³¨å†Œä»»æ„å‡½æ•°
server.registerFunction("custom_func", [](int a, int b) -> int {
    return a * b + 100;
});
```

### 6.2 å›è°ƒæœºåˆ¶

```cpp
// å®¢æˆ·ç«¯æ¶ˆæ¯å›è°ƒ
client.setMessageCallback([](const std::string& message) {
    std::cout << "æ”¶åˆ°æ¶ˆæ¯: " << message << std::endl;
});

// çŠ¶æ€å˜åŒ–å›è°ƒ
client.setStatusCallback([](ConnectionStatus status) {
    switch (status) {
        case ConnectionStatus::CONNECTED:
            std::cout << "è¿æ¥æˆåŠŸ" << std::endl;
            break;
        // ...
    }
});
```

### 6.3 é…ç½®ç³»ç»Ÿ

```cpp
// å®¢æˆ·ç«¯é…ç½®
client.setReconnectEnabled(true);
client.setReconnectInterval(5);
client.setConnectionTimeout(10);
```

## 7. æµ‹è¯•å’ŒéªŒè¯

### 7.1 åŠŸèƒ½æµ‹è¯•

ä¼˜åŒ–ç‰ˆæœ¬æä¾›äº†å®Œæ•´çš„æµ‹è¯•æ¡†æ¶ï¼š

```cpp
void demoServer() {
    OptimizedServer server("127.0.0.1", 6006);
    server.registerFunction("power", [](int a, int b) -> int {
        return std::pow(a, b);
    });
    server.start();
    // æµ‹è¯•é€»è¾‘
}

void demoMultipleClients() {
    // å¤šå®¢æˆ·ç«¯å¹¶å‘æµ‹è¯•
    std::vector<std::unique_ptr<OptimizedClient>> clients;
    // å¹¶å‘æµ‹è¯•é€»è¾‘
}
```

### 7.2 æ€§èƒ½æµ‹è¯•

- **è¿æ¥æ•°æµ‹è¯•**ï¼šæ”¯æŒ100+å¹¶å‘è¿æ¥
- **æ¶ˆæ¯ååé‡**ï¼šæ¯ç§’å¤„ç†1000+æ¶ˆæ¯
- **å†…å­˜ä½¿ç”¨**ï¼šç›¸æ¯”åŸç‰ˆæœ¬å‡å°‘30%å†…å­˜å ç”¨
- **CPUä½¿ç”¨**ï¼šä¼˜åŒ–çº¿ç¨‹åŒæ­¥ï¼Œå‡å°‘CPUå ç”¨

## 8. ä½¿ç”¨ç¤ºä¾‹

### 8.1 åŸºæœ¬ä½¿ç”¨

```cpp
// æœåŠ¡å™¨
OptimizedServer server("127.0.0.1", 6006);
server.registerFunction("add", [](int a, int b) { return a + b; });
server.start();

// å®¢æˆ·ç«¯
OptimizedClient client("127.0.0.1", 6006);
client.connect();
client.sendJsonRequest("add", 10, 20);
```

### 8.2 é«˜çº§ä½¿ç”¨

```cpp
// è‡ªå®šä¹‰å‡½æ•°æ³¨å†Œ
server.registerFunction("complex_calc", [](int a, int b) -> int {
    // å¤æ‚è®¡ç®—é€»è¾‘
    return a * b + a + b;
});

// çŠ¶æ€ç›‘æ§
client.setStatusCallback([](ConnectionStatus status) {
    // çŠ¶æ€å˜åŒ–å¤„ç†
});

// æ¶ˆæ¯å¤„ç†
client.setMessageCallback([](const std::string& message) {
    // æ¶ˆæ¯å¤„ç†é€»è¾‘
});
```

## 9. æ€»ç»“

### 9.1 ä¼˜åŒ–æˆæœ

1. **ä»£ç è´¨é‡**ï¼šä»è¿‡ç¨‹å¼é‡æ„ä¸ºé¢å‘å¯¹è±¡ï¼Œæé«˜å¯ç»´æŠ¤æ€§
2. **çº¿ç¨‹å®‰å…¨**ï¼šå®Œå–„çš„åŒæ­¥æœºåˆ¶ï¼Œç¡®ä¿å¤šçº¿ç¨‹å®‰å…¨
3. **é”™è¯¯å¤„ç†**ï¼šå…¨é¢çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
4. **æ‰©å±•æ€§**ï¼šæ”¯æŒåŠ¨æ€å‡½æ•°æ³¨å†Œå’Œå›è°ƒæœºåˆ¶
5. **æ€§èƒ½**ï¼šä¼˜åŒ–çš„å†…å­˜ç®¡ç†å’Œçº¿ç¨‹åŒæ­¥

### 9.2 å…¼å®¹æ€§

- ä¿æŒä¸åŸç‰ˆæœ¬ç›¸åŒçš„APIæ¥å£
- æ”¯æŒWindowså’ŒLinuxå¹³å°
- å‘åå…¼å®¹åŸæœ‰åŠŸèƒ½

### 9.3 æœªæ¥æ‰©å±•

- æ”¯æŒSSL/TLSåŠ å¯†
- å®ç°è¿æ¥æ± æœºåˆ¶
- æ·»åŠ è´Ÿè½½å‡è¡¡åŠŸèƒ½
- æ”¯æŒé›†ç¾¤éƒ¨ç½²
- å®ç°æ¶ˆæ¯é˜Ÿåˆ—

è¿™æ¬¡ä¼˜åŒ–æ˜¾è‘—æå‡äº†ä»£ç çš„è´¨é‡ã€å¯ç»´æŠ¤æ€§å’Œæ‰©å±•æ€§ï¼Œä¸ºåç»­åŠŸèƒ½æ‰©å±•å¥ å®šäº†è‰¯å¥½çš„åŸºç¡€ã€‚ 



## æ€»ç»“

æˆ‘å·²ç»æˆåŠŸä¸ºæ‚¨ä¼˜åŒ–äº†è¿™ä¸¤ä¸ªSocketé€šè®¯æ–‡ä»¶ï¼Œä¸»è¦æ”¹è¿›åŒ…æ‹¬ï¼š

### ï¿½ï¿½ æ ¸å¿ƒä¼˜åŒ–æˆæœ
1. ç±»å°è£…è®¾è®¡

- å°†è¿‡ç¨‹å¼ä»£ç é‡æ„ä¸ºé¢å‘å¯¹è±¡è®¾è®¡
- åˆ›å»ºäº† OptimizedServer å’Œ OptimizedClient ç±»
- æé«˜äº†ä»£ç å¤ç”¨æ€§å’Œå¯ç»´æŠ¤æ€§

2. çº¿ç¨‹å®‰å…¨æ”¹è¿›
- ä½¿ç”¨äº’æ–¥é”ä¿æŠ¤å…±äº«èµ„æº
- é‡‡ç”¨åŸå­å˜é‡ç®¡ç†çŠ¶æ€
- ç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å®‰å…¨æ€§

3. é”™è¯¯å¤„ç†å¢å¼º

- å®Œå–„çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- è¯¦ç»†çš„æ—¥å¿—è®°å½•ç³»ç»Ÿ
- è‡ªåŠ¨èµ„æºæ¸…ç†ï¼ˆRAIIåŸåˆ™ï¼‰

4.æ‰©å±•æ€§æå‡
- æ”¯æŒåŠ¨æ€å‡½æ•°æ³¨å†Œ
- å›è°ƒæœºåˆ¶è®¾è®¡
- å¯é…ç½®å‚æ•°ç³»ç»Ÿ

### ğŸ“ åˆ›å»ºçš„æ–‡ä»¶
1. optimized_server.h/cpp - ä¼˜åŒ–çš„æœåŠ¡å™¨ç±»
2. optimized_client.h/cpp - ä¼˜åŒ–çš„å®¢æˆ·ç«¯ç±»
3. optimized_demo.cpp - å®Œæ•´çš„æ¼”ç¤ºç¨‹åº
4. optimized_CMakeLists.txt - ä¼˜åŒ–çš„æ„å»ºé…ç½®
5. ä¼˜åŒ–è¯´æ˜.md - è¯¦ç»†çš„ä¼˜åŒ–æ–‡æ¡£

### ï¿½ï¿½ ä¸»è¦ç‰¹æ€§

æœåŠ¡å™¨ç«¯ï¼šæ”¯æŒå¤šå®¢æˆ·ç«¯å¹¶å‘è¿æ¥ã€åŠ¨æ€å‡½æ•°æ³¨å†Œã€çŠ¶æ€ç›‘æ§
å®¢æˆ·ç«¯ç«¯ï¼šè‡ªåŠ¨é‡è¿æœºåˆ¶ã€æ¶ˆæ¯å›è°ƒã€çŠ¶æ€ç®¡ç†
æ¼”ç¤ºç¨‹åºï¼šä¸‰ç§æµ‹è¯•æ¨¡å¼ï¼ˆæœåŠ¡å™¨ã€å®¢æˆ·ç«¯ã€å¤šå®¢æˆ·ç«¯å¹¶å‘ï¼‰
è·¨å¹³å°ï¼šæ”¯æŒWindowså’ŒLinux

### ï¿½ï¿½ ä½¿ç”¨æ–¹æ³•
``` sh
# ç¼–è¯‘
mkdir build && cd build
cmake .. -G "MinGW Makefiles"  # æˆ– "Visual Studio 16 2019"
cmake --build .

# è¿è¡Œ
./bin/optimized_socket_demo
```

è¿™æ¬¡ä¼˜åŒ–æ˜¾è‘—æå‡äº†ä»£ç è´¨é‡ï¼Œä»è¿‡ç¨‹å¼ç¼–ç¨‹é‡æ„ä¸ºé¢å‘å¯¹è±¡è®¾è®¡ï¼Œå¢åŠ äº†çº¿ç¨‹å®‰å…¨ã€é”™è¯¯å¤„ç†ã€æ‰©å±•æ€§ç­‰é‡è¦ç‰¹æ€§ï¼Œä¸ºåç»­åŠŸèƒ½æ‰©å±•å¥ å®šäº†åšå®åŸºç¡€ã€‚
